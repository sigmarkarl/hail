function ri(t,i){return null==t&&(t=0),null==i&&(i=1),Math.floor(t+Math.random()*(i-t+1))}function getBrightness(t){return.299*t.r+.587*t.g+.114*t.b}function getPixelRatio(){return!window.devicePixelRatio||window.devicePixelRatio<2?2:window.devicePixelRatio}class Viz{constructor(t={}){if(!THREE.WebGLRenderer)return void console.error("ThreeJS has not been loaded, or WebGL is unsupported");if(this.options=Object.assign({color:16727937,backgroundColor:268435455,points:10,maxDistance:20,spacing:15,showDots:!0},t),this.el=document.querySelector(this.options.el),!this.el)return void console.error(`Cannot find ${this.options.el}`);"absolute"==!this.el.style.position&&(this.el.style.position="absolute"),this.el.style.opacity=0,this.hidden=!0,this.mouse={x:0,y:0,rawY:0,updated:!1,updatedCount:-1,ran:!1},this.highlightColor=new THREE.Color("purple"),this.cachedColor=new THREE.Color(0),this.options.color=new THREE.Color(this.options.color),this.options.backgroundColor=new THREE.Color(this.options.backgroundColor),this.diffColor=this.options.color.clone().sub(this.options.backgroundColor),this.colorB=getBrightness(new THREE.Color(this.options.color)),this.bgB=getBrightness(new THREE.Color(this.options.backgroundColor)),this.elOffset=this.el.offsetTop,this.elOnscreen=!1,this.isScrolling=!1,this.resizeTimeout=null,this.postInit=!1,this.points=[],this.animationTimeout=null,this.animationLoop=this.animationLoop.bind(this),window.requestAnimationFrame(()=>{let t=document.createElement("canvas"),i=t.getContext("webgl",{alpha:!0,antialias:!0});this.renderer=new THREE.WebGLRenderer({canvas:t,context:i}),this.el.appendChild(this.renderer.domElement)});let i=new IntersectionObserver(t=>{if(t.length>1&&console.warn("should be observing a single element, ignoring all but first"),this.elOnscreen=t[0].intersectionRatio>.6,this.interval=1e3/12,this.elOnscreen){if(!this.postInit){try{window.requestAnimationFrame(()=>{this.init(),this.listen(),this.then=Date.now(),this.animationLoop(),this.postInit=!0})}catch(t){return this.renderer&&this.renderer.domElement&&this.el.removeChild(this.renderer.domElement),void log.error(t)}return}this.animationLoop()}},{threshold:.6});window.requestAnimationFrame(()=>i.observe(this.renderer.domElement))}listen(){this.elOffset=this.el.offsetTop,this.isScrolling=!1,this.resizeTimeout=null,window.addEventListener("resize",t=>this.resize(t)),window.addEventListener("scroll",()=>{null!=this.isScrolling&&window.clearTimeout(this.isScrolling),this.isScrolling=setTimeout(()=>this.isScrolling=null,100)});let t=null;this.mouse.dontshow=!1,window.addEventListener("mousemove",i=>{null!=t&&clearTimeout(t),t=setTimeout(()=>{this.onMouseMove2(i),t=null},this.mouse.dontshow?32:4)},!1);const i=document.getElementById("hero-content"),e=document.getElementById("hail-navbar");i.onmouseover=(()=>{null!=t&&clearTimeout(t),this.mouse.updated=!1,this.mouse.updatedCount=0,this.mouse.dontshow=!0}),i.onmouseout=(()=>{null!=t&&clearTimeout(t),this.mouse.updated=!0,this.mouse.updatedCount=0,this.mouse.dontshow=!1}),e.onmouseover=(()=>{null!=t&&clearTimeout(t),this.mouse.updated=!1,this.mouse.updatedCount=0,this.mouse.dontshow=!0}),e.onmouseout=(()=>{null!=t&&clearTimeout(t),this.mouse.updated=!0,this.mouse.updatedCount=0,this.mouse.dontshow=!1})}resize(t){null!=this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{this.hidden=!0,this.camera&&(this.camera.aspect=this.el.offsetWidth/this.el.offsetHeight,"function"==typeof this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix()),this.renderer&&(this.renderer.setSize(this.el.offsetWidth,this.el.offsetHeight),this.renderer.setPixelRatio(getPixelRatio())),this.animationLoop(),this.resizeTimeout=null},128)}animationLoop(t=33){if(!this.hidden&&!this.mouse.updated)return void(null!=this.animationTimeout&&(clearTimeout(this.animationTimeout),this.animationTimeout=null));if(this.startedAnimation||!this.elOnscreen)return void(null!=this.animationTimeout&&(clearTimeout(this.animationTimeout),this.animationTimeout=null));null!=this.animationTimeout&&clearTimeout(this.animationTimeout);const i=Date.now(),e=i-this.then;if(this.isScrolling||(this.hidden||e>this.interval)&&(this.onUpdate(),this.scene&&this.camera&&this.renderer.render(this.scene,this.camera),this.mouse.updated=!1),this.hidden)return this.startedAnimation=!0,void window.requestAnimationFrame(()=>{this.el.style.opacity=.5,this.hidden=!1,this.startedAnimation=!1,this.then=i-1e3-e%this.interval,this.animationTimeout=window.setTimeout(()=>{this.animationLoop(t),this.animationTimeout=null},t)});this.then=i-e%this.interval}onMouseMove2(t){if(!this.elOnscreen||this.mouse.dontshow)return;if(!this.mouse.ran)return void(this.mouse.ran=!0);this.rayCaster||(this.rayCaster=new THREE.Raycaster);const i=t.pageX,e=t.pageY-this.elOffset,o=i/this.el.offsetWidth*2-1,s=-e/this.el.offsetHeight*2+1;o===this.mouse.x&&s===this.mouse.y||(this.mouse.x=o,this.mouse.y=s,this.mouse.updated=!0,this.mouse.updatedCount=0,this.rayCaster.setFromCamera(new THREE.Vector2(this.mouse.x,this.mouse.y),this.camera),this.animationLoop())}genPoint(t,i,e){const o=new THREE.SphereGeometry(.2,12,12),s=new THREE.MeshLambertMaterial({color:this.options.color,transparent:!0,opacity:.35}),n=new THREE.Mesh(o,s);return n.position.set(t,i,e),n.r=25e-5*(4*Math.random()-2),n}init(){const t=new THREE.Group;t.position.set(0,0,0);let{points:i,spacing:e}=this.options;const o=i*i*2;this.linePositions=new Float32Array(o*o*3),this.lineColors=new Float32Array(o*o*3);const s=new THREE.BufferGeometry;s.setAttribute("position",new THREE.BufferAttribute(this.linePositions,3)),s.setAttribute("color",new THREE.BufferAttribute(this.lineColors,3)),s.computeBoundingSphere(),s.setDrawRange(0,0);const n=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});n.linewidth=.25,this.linesMesh=new THREE.LineSegments(s,n),this.linesMesh.renderOrder=2,t.add(this.linesMesh);for(let o=0;o<=i;o++)for(let s=0;s<=i;s++){const n=ri(-3,3),r=(o-i/2)*e+ri(-5,5);let h=(s-i/2)*e+ri(-5,5);o%2&&(h+=.5*e);const l=this.genPoint(r,n-ri(5,15),h),a=this.genPoint(r+ri(-5,5),n+ri(5,15),h+ri(-5,5));t.add(l,a),this.points.push(l,a)}this.renderer.setSize(this.el.offsetWidth,this.el.offsetHeight),this.renderer.setPixelRatio(getPixelRatio()),this.camera=new THREE.PerspectiveCamera(25,this.el.offsetWidth/this.el.offsetHeight,.01,1e4),this.camera.position.set(50,100,150),this.camera.lookAt(0,0,0),this.scene=new THREE.Scene,this.scene.add(this.camera),this.scene.add(new THREE.AmbientLight(16777215,.75)),this.scene.add(t)}onUpdate(){let t,i,e,o,s,n,r=0,h=0,l=0,a=0;for(let u=0;u<this.points.length;u++){o=this.points[u],this.rayCaster&&(this.mouse.updated?(i=.25*(12-this.rayCaster.ray.distanceToPoint(o.position)))>1?(a=1,o.material.color=this.highlightColor):(a=0,o.material.color=this.options.color):o.material.color!==this.options.color&&(o.material.color=this.options.color)),0!==o.r&&(n=Math.atan2(o.position.z,o.position.x)+o.r,t=Math.sqrt(o.position.z**2+o.position.x**2),o.position.x=t*Math.cos(n),o.position.z=t*Math.sin(n));for(let i=u;i<this.points.length;i++)if(s=this.points[i],!((t=Math.sqrt((o.position.x-s.position.x)**2+(o.position.y-s.position.y)**2+(o.position.z-s.position.z)**2))>=this.options.maxDistance)){if(a)e=this.highlightColor;else{let i=1-t/this.options.maxDistance;i<0?i=0:i>1&&(i=1),e=this.options.backgroundColor.clone().lerp(this.options.color,i)}this.linePositions[r++]=o.position.x,this.linePositions[r++]=o.position.y,this.linePositions[r++]=o.position.z,this.linePositions[r++]=s.position.x,this.linePositions[r++]=s.position.y,this.linePositions[r++]=s.position.z,this.lineColors[h++]=e.r,this.lineColors[h++]=e.g,this.lineColors[h++]=e.b,this.lineColors[h++]=e.r,this.lineColors[h++]=e.g,this.lineColors[h++]=e.b,l++}}this.linesMesh.geometry.setDrawRange(0,2*l),this.linesMesh.geometry.attributes.position.needsUpdate=!0,this.linesMesh.geometry.attributes.color.needsUpdate=!0}}export default Viz;